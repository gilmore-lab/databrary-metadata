---
title: "NSF Projects on Databrary"
output: html_document
date: "`r Sys.Date()`"
params:
  max_vol_id: 1603
  vb: TRUE
  import_saved: TRUE
  eval_test: FALSE
---

```{r setup, include=FALSE, message=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Purpose

This document describes the process for providing full funding data for projects shared on Databrary that list the U.S. National Science Foundation as a funding source.

Databrary stores a funding name, and a text field with the award ID, but it does not include the project title, funding amount, or other data related to an award.
That data is available, however, from the NSF.

This document uses the `databraryapi` package to extract information about the projects (volumes) that list NSF as a funder and then pulls additional data from the NSF's data via the NSF API.

Most of the work is done via functions listed in `R/functions.R`.

```{r}
source("R/functions.R")
```

## Preliminary testing

### Extract NSF-funded projects from Databrary

For efficiency reasons, we test the workflow by limiting the number of Databrary volumes queried.

The following chunks have been disabled (`eval = FALSE`).

```{r retrieve-nsf-vol1-200, eval=params$eval_test}
vols_1_200 <- get_multiple_vol_nsf_awards(1:200)
```

```{r print-vol1-200, eval=FALSE}
vols_1_200 |>
  dplyr::select(vol_id, award) |>
  knitr::kable(format = 'html') |>
  kableExtra::kable_material()
```

### Extract details from NSF

```{r, eval=params$eval_test}
vols_1_200_clean <- add_clean_nsf_award_id(vols_1_200)
```

```{r get-nsf-award-info-vol1-200, eval=params$eval_test}
nsf_vols_1_200 <- get_mult_nsf_awards(vols_1_200_clean$award_id)
```

```{r print-nsf-vol1-200, eval=params$eval_test}
nsf_vols_1_200 |>
  dplyr::select(-agency) |>
  dplyr::arrange(awardeeName, desc(date)) |>
  knitr::kable(format = 'html') |>
  kableExtra::kable_material() |>
  kableExtra::scroll_box(width = "600px", height = "300px")
```

### Save data

```{r save-csvs, eval=params$eval_test}
readr::write_csv(nsf_vols_1_200, "csv/databrary-nsf-funding-details-TEST.csv")
readr::write_csv(vols_1_200_clean, "csv/databrary-vols-w-nsf-funding-TEST.csv")
```

### Visualize data

```{r nsf-award-histogram, fig.cap="Histogram of NSF awards for selected Databrary volumes", eval=params$eval_test}
nsf_vols_1_200 |>
  dplyr::mutate(award_amt = as.numeric(fundsObligatedAmt)) |>
  ggplot2::ggplot() +
  ggplot2::aes(award_amt) +
  ggplot2::geom_histogram(bins=10)
```

## Full dataset

### Re-import

We re-import the saved data for visualizations if `params$import_saved` == TRUE`.

```{r import-saved, eval=params$import_saved}
db_nsf <- readr::read_csv("csv/databrary-vols-w-nsf-funding-all.csv", show_col_types = FALSE)
nsf <- readr::read_csv("csv/databrary-nsf-funding-details-all.csv", show_col_types = FALSE)
```

### Extract NSF-funded projects from Databrary

If `params$import_saved` == FALSE`, we regenerate the data.

```{r get-all-db-vols-w-nsf, eval=!params$import_saved}
db_nsf <- get_multiple_vol_nsf_awards(1:params$max_vol_id, vb = params$vb)
db_nsf <- add_clean_nsf_award_id(db_nsf)
```

```{r show-table-databrary-vols-listing-nsf}
db_nsf |>
  dplyr::select(vol_id, award) |>
  knitr::kable(format = 'html') |>
  kableExtra::kable_material() |>
  kableExtra::scroll_box(width = "600px", height = "300px")
```

### Extract details from NSF

```{r get-nsf-details-for-all, eval=!params$import_saved}
nsf <- get_mult_nsf_awards(db_nsf$award_id, vb = params$vb)
```

```{r show-table-nsf-info}
nsf |>
  dplyr::select(-agency) |>
  dplyr::arrange(awardeeName, desc(date)) |>
  knitr::kable(format = 'html') |>
  kableExtra::kable_material() |>
  kableExtra::scroll_box(width = "600px", height = "300px")
```

### Save data

```{r save-csvs-all, , eval=!params$import_saved}
readr::write_csv(nsf, "csv/databrary-nsf-funding-details-all.csv")
readr::write_csv(db_nsf, "csv/databrary-vols-w-nsf-funding-all.csv")
```

### Visualize

```{r nsf-award-histogram-all, fig.cap="Histogram of NSF awards for all Databrary volumes."}
nsf |>
  dplyr::mutate(award_amt = as.numeric(fundsObligatedAmt)) |>
  ggplot2::ggplot() +
  ggplot2::aes(award_amt) +
  ggplot2::geom_histogram(bins=10)
```

There are $n=$ `r dim(db_nsf)[1]` Databrary volumes that list NSF as a funder.

These represent $n=$ `r db_nsf$award_id |> na.omit() |> unique() |> length()` unique NSF awards.

Of these, we were able to extract data from the NSF API for $n=$ `r nsf$id |> unique() |> length()` NSF awards.

The following volumes do not have matching NSF awards.

```{r}
db_not_found_in_nsf <- !(db_nsf$award_id %in% nsf$id)

db_nsf |>
  dplyr::filter(db_not_found_in_nsf) |>
  dplyr::select(vol_id, award) |>
  knitr::kable(format = 'html') |>
  kableExtra::kable_material() |>
  kableExtra::scroll_box(width = "600px", height = "300px")
```

## (TODO) Merge NSF and Databrary info

[^1]: In a form that permits us to query the NSF API.
